<?php

declare(strict_types=1);

use Fisharebest\Webtrees\Http\RequestHandlers\ControlPanel;
use Fisharebest\Webtrees\Http\RequestHandlers\ModulesAllPage;
use Fisharebest\Webtrees\I18N;
use Fisharebest\Webtrees\View;

/**
 * @var string $title
 * @var array<int, array> $configs
 * @var array<int, \Fisharebest\Webtrees\User> $users
 * @var array<int, \Fisharebest\Webtrees\Tree> $trees
 * @var \Tywed\Webtrees\Module\Telegram\Telegram $module
 */

?>

<?php echo view('components/breadcrumbs', ['links' => [route(ControlPanel::class) => I18N::translate('Control panel'), route(ModulesAllPage::class) => I18N::translate('Modules'), $title]]) ?>

<h1><?php echo $title ?></h1>

<div class="mb-3">
    <a href="<?php echo route('module', ['module' => $module->name(), 'action' => 'ConfigAdd']) ?>" class="btn btn-success">
        <?php echo view('icons/add') ?>
        <?php echo I18N::translate('Add new configuration') ?>
    </a>
</div>

<?php if (empty($configs)) : ?>
    <div class="alert alert-info" role="alert">
        <?php echo I18N::translate('No Telegram configurations found. Please add a new one.') ?>
    </div>
<?php else : ?>
    <table class="table table-sm table-bordered table-striped">
        <thead>
            <tr>
                <th><?php echo I18N::translate('Name') ?></th>
                <th><?php echo I18N::translate('Chat ID') ?></th>
                <th><?php echo I18N::translate('User') ?></th>
                <th><?php echo I18N::translate('Tree') ?></th>
                <th><?php echo I18N::translate('Status') ?></th>
                <th><?php echo I18N::translate('Last Run') ?></th>
                <th><?php echo I18N::translate('Last Error') ?></th>
                <th><?php echo I18N::translate('Actions') ?></th>
            </tr>
        </thead>
        <tbody>
            <?php foreach ($configs as $config) : ?>
                <tr>
                    <td><?php echo e($config['name'] ?? '') ?></td>
                    <td><?php echo e($config['chat_id'] ?? '') ?></td>
                    <td><?php echo e($users[$config['user_id'] ?? '']->realName() ?? '') ?></td>
                    <td><?php echo e($trees[$config['tree_id'] ?? '']->title() ?? '') ?></td>
                    <td>
                        <?php if ($config['enabled'] ?? true) : ?>
                            <span class="badge bg-success"><?php echo I18N::translate('Enabled') ?></span>
                        <?php else : ?>
                            <span class="badge bg-secondary"><?php echo I18N::translate('Disabled') ?></span>
                        <?php endif ?>
                    </td>
                    <td>
                        <?php if (isset($config['last_launch'])) : ?>
                            <?php echo date('Y-m-d H:i:s', (int)$config['last_launch']) ?>
                        <?php else : ?>
                            <span class="text-muted"><?php echo I18N::translate('Never') ?></span>
                        <?php endif ?>
                    </td>
                    <td>
                        <?php if (!empty($config['last_error'])) : ?>
                            <span class="text-danger" title="<?php echo e($config['last_error']) ?>">
                                <?php echo I18N::translate('Error') ?>
                                <?php if (isset($config['last_error_date'])) : ?>
                                    <br><small><?php echo date('Y-m-d H:i:s', (int)$config['last_error_date']) ?></small>
                                <?php endif ?>
                            </span>
                        <?php else : ?>
                            <span class="text-success"><?php echo I18N::translate('OK') ?></span>
                        <?php endif ?>
                    </td>
                    <td>
                        <div class="btn-group" role="group">
                            <form method="post" action="<?php echo route('module', ['module' => $module->name(), 'action' => 'Admin']) ?>" style="display: inline;">
                                <?php echo csrf_field() ?>
                                <input type="hidden" name="action" value="test">
                                <input type="hidden" name="id" value="<?php echo e($config['id']) ?>">
                                <input type="hidden" name="bot_token" value="<?php echo e($config['bot_token'] ?? '') ?>">
                                <input type="hidden" name="chat_id" value="<?php echo e($config['chat_id'] ?? '') ?>">
                                <button type="submit" class="btn btn-sm btn-secondary">
                                    <?php echo view('icons/email') ?>
                                    <?php echo I18N::translate('Send test message') ?>
                                </button>
                            </form>
                            <a href="<?php echo route('module', ['module' => $module->name(), 'action' => 'ConfigEdit', 'id' => $config['id']]) ?>" class="btn btn-sm btn-primary">
                                <?php echo view('icons/edit') ?>
                                <?php echo I18N::translate('Edit') ?>
                            </a>
                            <form method="post" action="<?php echo route('module', ['module' => $module->name(), 'action' => 'Admin']) ?>" style="display: inline;" onsubmit="return confirm('<?php echo I18N::translate('Are you sure you want to delete this configuration?') ?>')">
                                <?php echo csrf_field() ?>
                                <input type="hidden" name="action" value="delete">
                                <input type="hidden" name="id" value="<?php echo e($config['id']) ?>">
                                <button type="submit" class="btn btn-sm btn-danger">
                                    <?php echo view('icons/delete') ?>
                                    <?php echo I18N::translate('Delete') ?>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
            <?php endforeach ?>
        </tbody>
    </table>
<?php endif ?>

<div class="mt-4">
    <div class="row mb-3">
        <p>
        <h6>
            <?php echo I18N::translate('Cron Job URL') . ':'; ?>
        </h6>
        </p>
        <span class="input-group-text" dir="ltr">
            <?php echo "0 9 * * * wget -O - -q " . '"' . e(rawurldecode(route('module', ['module' => $module->name(), 'action' => 'Cron']))) . '"' ?>
        </span>
        <div class="form-text">
            <?php echo I18N::translate('Copy this link and put it into your cron on the server. This cron job will process all active Telegram configurations. The default setting is 9 hours of every day.') ?>
        </div>
    </div>

    <div class="row mb-3">
        <p>
        <h6>
            <?php echo I18N::translate('Changes Cron Job URL') . ':'; ?>
        </h6>
        </p>
        <span class="input-group-text" dir="ltr">
            <?php echo "0 10 * * * wget -O - -q " . '"' . e(rawurldecode(route('module', ['module' => $module->name(), 'action' => 'ChangesCron']))) . '"' ?>
        </span>
        <div class="form-text">
            <?php echo I18N::translate('Use this URL in your cron job to send daily change notifications') ?>
        </div>
    </div>
</div>
